<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Solution Pattern: Recommendation Engine using Event Streaming :: Solution Patterns for Cloud Native Architectures</title>
    <link rel="canonical" href="https://redhat-solution-patterns.github.io/solution-patterns/solution-pattern-template/03-demo.html">
    <link rel="prev" href="02-architecture.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MGNB0XZV9T"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MGNB0XZV9T');
</script>
<!-- Google tag (gtag.js) -->

<header class="header">
  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () { 
      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get('USERID');
      const subdomain = urlParams.get('SUBDOMAIN'); 
      if (userId) {
        showUserId( userId, subdomain);
      }
      else {
        showUserIdForm(subdomain);
      }
    } );


    function showUserId( userId, subdomain) {
      document.getElementById('navbar-form-empty').style.display = "none";
      document.getElementById('navbar-form-filled').style.display = "flex";
      document.getElementById('userIdDisplay').textContent = "User ID : " + userId;
      document.getElementById('subdomainDisplay').textContent = "Subdomain : " + subdomain; 
    }

    function showUserIdForm( subdomain ) {
      document.getElementById('navbar-form-empty').style.display = "flex";
      document.getElementById('navbar-form-filled').style.display = "none";
      document.getElementById('subdomain').value = subdomain; 

    }

    function goWithUserId() {
      elUserIdInput = document.getElementById('userId');
      elSubdomainInput = document.getElementById('subdomain');
      window.location.search = ('&USERID=' + elUserIdInput.value  + '&SUBDOMAIN=' + elSubdomainInput.value);
    }

    function recycle() {
      document.getElementById('userId').value='';
      document.getElementById('subdomain').value='';
      window.location.search = ('');
    }


  </script>
  <nav class="navbar">
   <div class="navbar-brand">
      <a class="navbar-item" style="font-size: 20px; color: white" href="https://redhat-solution-patterns.github.io/solution-patterns">
        <img src="../_/img/logo.png" height="35px" alt="Solution Patterns">&nbsp; Solution Patterns for Cloud Native Architectures</a>
      <button class="navbar-burger" data-target="topbar-nav">
      </button>
      
    </div>
    <div class="navbar-item" ><span class="navbar-text" style="color: white; margin-left: 1rem; margin-right: 1rem;">|</span></div>
    
    <div class="navbar-item has-dropdown is-hoverable" >
      <a class="navbar-link" href="#" style="color: white">Red Hat Patterns</a>
      <div class="navbar-dropdown">
        <a class="navbar-item" href="https://www.redhat.com/architect/portfolio/" target="_blank">Portfolio Architecture&nbsp; </a>
        <a class="navbar-item" href="https://redhat-solution-patterns.github.io/solution-patterns/patterns.html" target="_blank">Solution Patterns </a>
        <a class="navbar-item" href="https://validatedpatterns.io/" target="_blank">Validated Patterns&nbsp;</a>

      </div>
    </div>
    <div class="navbar-item has-dropdown is-hoverable" >
      <a class="navbar-link" href="#" style="color: white">Resources</a>
      <div class="navbar-dropdown">
        <a class="navbar-item" target="_blank" href="https://www.redhat.com/en/products/application-foundations">Red Hat Application Services</a>
        <a class="navbar-item" target="_blank" href="https://developers.redhat.com/app-dev-platform">App Dev Platform</a>
      </div>
    </div>

    <div class="navbar-item" ><span class="navbar-text" style="color: white; margin-left: 1rem; margin-right: 1rem;">|</span></div>


    

    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        


        <div class="navbar-item" id="navbar-form-empty">
          <span class="navbar-text" style="margin-left: 2rem;">
          <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">&nbsp;<i style="color: orange;"
              class="fa fa-exclamation-triangle" aria-hidden="true"></i></span>
            Your Workshop Environment

          <form action="javascript:void(0);" onsu>
            <input size="20" id="userId" type="text" placeholder="USER ID">
            <input size="20" id="subdomain" type="text" placeholder="Subdomain">
            <button type="hidden" onclick="goWithUserId();">Set</button>
          </form>
        </div>
        
        <div class="navbar-item" id="navbar-form-filled" style="display: none;">
          <span class="navbar-text" style="margin-left: 2rem;">
          <span class="navbar-text " style="margin-left: 1rem; margin-right: 1rem; float:left">
            &nbsp;Your Workshop Environment <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">&nbsp;<i alt="Clear details" title="Clear details" onclick="recycle();" style="color: green;" class="fa fa-recycle" aria-hidden="true"></i>

          <br><span  id="userIdDisplay"></span> <span  style="color: white; margin-left: 1rem; margin-right: 1rem;">|</span>
          <span id="subdomainDisplay"></span>
        </div>

        
        </span>

    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="solution-pattern-template" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Recommendation Engine using Event Streaming</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">1. Home page</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#use-cases">1.1 Use cases</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_the_story_behind_this_solution_pattern">1.2 The story behind this solution pattern</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_the_solution">1.3 The solution</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_developer_resources">1.4 Developer Resources</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-architecture.html">2. Architecture</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-architecture.html#tech_stack">2.1. Technology stack</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-architecture.html#in_depth">2.2. An in-depth look at the solution&#8217;s architecture</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-demo.html">3. See the Solution in Action</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_setup_the_solution">3.1. Setup the solution</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_walkthrough_guide">3.2. Walkthrough guide</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text"><a href="https://redhat-solution-patterns.github.io/solution-patterns/patterns.html" target="_blank" rel="noopener">Explore Red Hat Solution Patterns</a></span>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Recommendation Engine using Event Streaming</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Recommendation Engine using Event Streaming</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Recommendation Engine using Event Streaming</a></li>
    <li><a href="03-demo.html">3. See the Solution in Action</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-solution-patterns/solution-pattern-recommendation-engine/edit/main/documentation/modules/ROOT/pages/03-demo.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Solution Pattern: Recommendation Engine using Event Streaming</h1>
<h1 id="_see_the_solution_in_action" class="sect0"><a class="anchor" href="#_see_the_solution_in_action"></a><a class="link" href="#_see_the_solution_in_action">See the Solution in Action</a></h1>
<div class="sect1">
<h2 id="_setup_the_solution"><a class="anchor" href="#_setup_the_solution"></a><a class="link" href="#_setup_the_solution">1. Setup the Solution</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>To provision the demo you will perform the following steps - each of which are explained in detail in the next sections:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Gain access to Red Hat OpenShift. This solution pattern has been tested on <a href="https://docs.openshift.com/container-platform/4.13/welcome/index.html" target="_blank" rel="noopener">OpenShift 4.13</a></p>
</li>
<li>
<p>Ensure you have the tools <code>oc</code> and <code>ansible</code> installed in your local environment such as your laptop</p>
</li>
<li>
<p>Access the OpenShift cluster with cluster-admin privileges</p>
</li>
<li>
<p>Log in to OpenShift with <code>cluster-admin</code> role via cli</p>
</li>
<li>
<p>Run the Ansible playbook</p>
</li>
<li>
<p>Run a  bunch of scripts to deploy the Solution Pattern in your OpenShift cluster</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_before_getting_started"><a class="anchor" href="#_before_getting_started"></a><a class="link" href="#_before_getting_started">1.1. Pre-requisites</a></h3>
<div class="paragraph">
<p>Here is the list of tools you need in your local enviroment so that you can use the automated installation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.openshift.com/container-platform/4.13/cli_reference/openshift_cli/getting-started-cli.html" target="_blank" rel="noopener">OpenShift CLI (oc client)</a></p>
</li>
<li>
<p><a href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html" target="_blank" rel="noopener">Ansible CLI </a></p>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.ansible.com/ansible/latest/collections/kubernetes/core/k8s_module.html" target="_blank" rel="noopener">Ansible kubernetes.core module</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>To check if you have the cli tools, you can open your terminal and use following commands:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell script hljs" data-lang="shell script">oc version #openshift cli client
ansible --version
ansible-galaxy --version
ansible-galaxy collection list #the list should include kubernetes.core</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you can&#8217;t see <code>kubernetes.core</code> collection listed, you can install it with <code>ansible-galaxy</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell script hljs" data-lang="shell script">ansible-galaxy collection install kubernetes.core</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_installing_the_demo"><a class="anchor" href="#_installing_the_demo"></a><a class="link" href="#_installing_the_demo">1.2. Installing the demo</a></h3>
<div class="ulist">
<ul>
<li>
<p>Login to your OpenShift cluster as cluster-admin (because a number of operators will need to be installed)</p>
</li>
<li>
<p>Click on the username on the top right hand, and then click on <strong>Copy login command</strong>. This will open another tab and you will need to login again</p>
</li>
<li>
<p>Click on <strong>Display token</strong> link, and copy the command under  <strong>Log in with this token</strong>. This will look like this</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>oc login --token=&lt;token&gt; --server=&lt;server&gt;</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Clone the ansible scripts as follows in an appropriate folder in your local environment</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell script hljs" data-lang="shell script">git clone https://github.com/rh-solution-pattern-event-streaming/ansible</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Navigate to the <code>ansible</code> folder</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell script hljs" data-lang="shell script">cd ansible</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Run the ansible playbook as shown below. This will take a few minutes to complete. Ensure that the ansible playbook is deployed without errors</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell script hljs" data-lang="shell script">ansible-playbook playbook.yml</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>This is the output you get from the above ansible command:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>PLAY RECAP PLAY RECAP ***********************************************************************************************************************************************************
localhost                  : ok=59   changed=0    unreachable=0    failed=0    skipped=23   rescued=0    ignored=0</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s it! You are set to try out this Solution Pattern! ｡◕‿◕｡</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_walkthrough_guide"><a class="anchor" href="#_walkthrough_guide"></a><a class="link" href="#_walkthrough_guide">2. Walkthrough guide</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the following sections you will follow this journey:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add event streaming to the Globex retail application to track user activity</p>
</li>
<li>
<p>Use Kafka streams to then highlight featured products</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this part of the workshop you will connect the Activity Tracking and Recommendation Engine applications to the Apache Kafka broker using <a href="https://docs.openshift.com/container-platform/latest/applications/connecting_applications_to_services/understanding-service-binding-operator.html" class="external" target="_blank" rel="noopener">Service Binding</a>.</p>
</div>
<div id="event-goals" class="paragraph">
<p>You will be using the OpenShift Developer Console to configure the service binding. Note that these steps can also be achieved using the Red Hat OpenShift (<code>oc</code>) CLI.</p>
</div>
<div class="paragraph">
<p>Note:  <a href="#service-binding-appendix">Click to learn more about Service Binding</a></p>
</div>
<div class="sect2">
<h3 id="_personalize_this_instructions"><a class="anchor" href="#_personalize_this_instructions"></a><a class="link" href="#_personalize_this_instructions">2.1. Personalize this instructions</a></h3>
<div class="paragraph">
<p>To personalize the rest of the instructions to your OpenShift enviroment,</p>
</div>
<div class="ulist">
<ul>
<li>
<p>At the top-right of this page enter</p>
<div class="ulist">
<ul>
<li>
<p><strong>username</strong> as <code>user1</code></p>
</li>
<li>
<p><strong>subdomain</strong> to match your OpenShift cluster under the <strong>Your Workshop Environment</strong> section</p>
</li>
</ul>
</div>
</li>
<li>
<p>Press enter or click on the Set button</p>
<div class="imageblock">
<div class="content">
<img src="_images/setup-instructions.png" alt="setup instructions">
</div>
</div>
</li>
<li>
<p>The menubar and the rest of this walkthrough guide will be updated with the username and subdomain as shown below</p>
<div class="imageblock">
<div class="content">
<img src="_images/setup-instructions-complete.png" alt="setup instructions complete">
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The subdomain would look something like this <code>apps.cluster-name.guid.subdomain.myopenshift.com</code></p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_explore_the_environment"><a class="anchor" href="#_explore_the_environment"></a><a class="link" href="#_explore_the_environment">2.2. Explore the environment</a></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In a browser window, navigate to the console of the lab OpenShift cluster at <a href="https://console-openshift-console.%SUBDOMAIN%/topology/ns/globex-%USERID%?view=graph" class="external" target="openshiftconsole">console</a>. Login with your username and password (<code>%USERID%/openshift</code>). Open the <strong>Developer</strong> perspective in the <strong>globex-%USERID%</strong> namespace.</p>
</li>
<li>
<p>In the Developer perspective, open the <strong>Topology</strong> view. Expect to see something like this (rearrange the topology as you see fit):</p>
<div class="imageblock">
<div class="content">
<img src="_images/globex-deployment-topology.png" alt="globex deployment topology">
</div>
</div>
<div class="paragraph">
<p>The deployed topology consists of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>globex-ui</code>: The Globex Coolstuff web application (Node.js/Angular).</p>
</li>
<li>
<p><code>catalog</code> and <code>catalog-database</code>: The Globex Coolstuff catalog service, consisting of the catalog database and the Spring Boot catalog microservice.</p>
</li>
<li>
<p><code>inventory</code> and <code>inventory-database</code>: The Globex Coolstuff inventory service, consisting of the inventory database and the Quarkus inventory microservice.</p>
</li>
<li>
<p><code>activity-tracking</code>: The Activity Tracking service. Notice that the deployment of the service is scaled to zero. The service will be scaled up once the connection to the Kafka broker is set up.</p>
</li>
<li>
<p><code>recommendation-engine</code>: The Recommendation Engine service. Notice that the deployment of the service is scaled to zero. The service will be scaled up once the connection to the Kafka broker is set up.</p>
</li>
<li>
<p><code>activity-tracking-simulator</code>: A Quarkus service that simulates user activity events and sends them to the Activity Tracking service.</p>
</li>
<li>
<p><code>kafka</code>: an instance of a Kafka broker, managed by the <em>AMQ Streams</em> operator. In the Topology view, the kafka deployment shows up as a single unit, but in reality it consists of several deployments: a ZooKeeper (3 nodes) to manage and maintain the internal state of the Kafka broker, the Kafka broker itself (2 broker nodes) and the Entity operator, which manages topics and users.</p>
</li>
<li>
<p><code>kafdrop</code>: a web UI for viewing Kafka topics and browsing consumer groups. The tool displays information such as brokers, topics, partitions, consumers, and lets you view messages.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Open the <strong>Globex UI</strong> application in a browser tab. To do so, click on the <span class="image"><img src="_images/console-open-url.png" alt="Open URL" width="30" height="30"></span> icon next to the blue circle representing the <strong>globex-ui</strong> deployment in the Topology view.</p>
<div class="paragraph">
<p>Alternatively, open a browser tab and navigate to <a href="https://globex-ui-globex-%USERID%.%SUBDOMAIN%/" class="external" target="_blank" rel="noopener">globex-ui</a></p>
</div>
<div class="paragraph">
<p>Expect to see the home page of the Globex Coolstuff web application:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/globex-coolstuff-home-page.png" alt="globex coolstuff home page">
</div>
</div>
</li>
<li>
<p>Click on <strong>Cool Stuff Store</strong> in the top menu to see a paginated list of products:</p>
<div class="imageblock">
<div class="content">
<img src="_images/globex-coolstuff-product-page.png" alt="globex coolstuff product page">
</div>
</div>
</li>
<li>
<p>The <em>Featured</em> pane on the home page is empty at the moment. Also the product list page has an empty bar above the product list. These elements will be populated once the recommendation engine is up and running.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_create_a_kafka_topic_in_the_amq_streams_kafka_broker"><a class="anchor" href="#_create_a_kafka_topic_in_the_amq_streams_kafka_broker"></a><a class="link" href="#_create_a_kafka_topic_in_the_amq_streams_kafka_broker">2.3. Create a Kafka Topic in the AMQ Streams Kafka broker</a></h3>
<div class="paragraph">
<p>The first thing to do is to create a topic in the Kafka broker which will receive the user activity events generated on the Globex web site.</p>
</div>
<div class="paragraph">
<p>When using AMQ Streams, topics can be created by deploying a Kubernetes Custom Resource (CR), that will be processed by the Entity Operator of AMQ Streams, which will use the Kafka APIs to create the topic on the broker.</p>
</div>
<div class="paragraph">
<p>A custom resource can be created directly in the OpenShift console.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On the OpenShift console, click on the <span class="image"><img src="_images/console-import-yaml.png" alt="console import yaml"></span> icon in the top menu on the right. This opens an editor where you can enter a Kubernetes resource definition in YAML or JSON format.</p>
</li>
<li>
<p>Paste the following <strong>KafkaTopic</strong> Custom Resource in the editor.</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  labels:
    strimzi.io/cluster: kafka
  name: globex.tracking
  namespace: globex-%USERID%
spec:
  topicName: globex.tracking
  partitions: 1
  replicas: 2
  config: {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Click <strong>Create</strong> to create the topic.</p>
</div>
<div class="paragraph">
<p>This creates a topic named <strong>globex.tracking</strong> with a single partition and two replicas, and default configuration (the <strong>config</strong> element allows you to define additional properties like message retention time and size etc&#8230;&#8203;).</p>
</div>
</li>
<li>
<p>The Kafdrop UI can be used to verify that the topic has been correctly created. In the Topology view of the <strong>globex-%USERID%</strong> namespace, click on the <span class="image"><img src="_images/console-open-url.png" alt="Open URL" width="30" height="30"></span> icon next to the blue circle representing the <strong>kafdrop</strong> deployment.</p>
<div class="paragraph">
<p>Alternatively, open a browser tab and navigate to <a href="https://kafdrop-globex-%USERID%.%SUBDOMAIN%/" class="external" target="_blank" rel="noopener">kafdrop</a>.</p>
</div>
</li>
<li>
<p>This redirects you to the Kafdrop home page. Scroll down to see the list of topics. Expect to see the <strong>globex.tracking</strong> topics, which you just created.</p>
<div class="imageblock">
<div class="content">
<img src="_images/kafdrop-landing-page.png" alt="kafdrop landing page">
</div>
</div>
<div class="paragraph">
<p>Click on the topic name to see the details of the topic. Notice that the topic has a single partition, and is empty at the moment.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/kafdrop-topic.png" alt="kafdrop topic">
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_binding_applications_to_apache_kafka"><a class="anchor" href="#_binding_applications_to_apache_kafka"></a><a class="link" href="#_binding_applications_to_apache_kafka">2.4. Binding applications to Apache Kafka</a></h3>
<div class="paragraph">
<p>In order for applications to be able to connect to a Kafka broker, the application needs to be configured with connection details like the Kafka bootstrap server URL, the security protocol and the user credentials. This is where <a href="https://docs.openshift.com/container-platform/4.10/applications/connecting_applications_to_services/understanding-service-binding-operator.html" class="external" target="_blank" rel="noopener">Service Binding</a> comes in. Service Binding allows to inject connection details from an e.g. secret directly into a pod.</p>
</div>
<div class="paragraph">
<p>Binding applications to services using Service Binding requires the Service Binding operator to be installed on the OpenShift cluster. The operator has been installed on your OpenShift cluster.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>As part of the provisioning of the Kafka broker, a secret <strong>kafka-client-secret</strong> was created in the <strong>globex-%USERID%</strong> namespace. To view the contents of the secret, click on <strong>Secrets</strong> in the left menu of the Developer perspective. Make sure you are pointing to the <strong>globex-%USERID%</strong> namespace.</p>
</li>
<li>
<p>In the list of secrets, locate the <strong>kafka-client-secret</strong> secret, and click on the name of the secret to open the secret details. Click on <strong>Reveal values</strong> to see the actual values stored in the secret.</p>
<div class="imageblock">
<div class="content">
<img src="_images/openshift-console-secret.png" alt="openshift console secret">
</div>
</div>
</li>
<li>
<p>To bind the <strong>Activity Tracking service</strong> and <strong>Recommendation Engine</strong> applications to the Kafka broker, create a <strong>ServiceBinding</strong> Custom Resource.</p>
<div class="paragraph">
<p>On the OpenShift console, click on the <span class="image"><img src="_images/console-import-yaml.png" alt="console import yaml"></span> icon in the top menu on the right. This opens an editor where you can enter a Kubernetes resource definition in YAML or JSON format.</p>
</div>
<div class="paragraph">
<p>Paste the following <strong>ServiceBinding</strong> Custom Resource in the editor.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: binding.operators.coreos.com/v1alpha1
kind: ServiceBinding
metadata:
  name: kafka-servicebinding
  namespace: globex-%USERID%
spec:
  application:
    group: apps
    labelSelector:
      matchLabels:
        service-binding/type: kafka
    resource: deployments
    version: v1
  bindAsFiles: true
  services:
    - group: ''
      kind: Secret
      name: kafka-client-secret
      version: v1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Click <strong>Create</strong> to create the Service Binding resource.</p>
</div>
<div class="paragraph">
<p>The Service Binding operator detects the creation of the Custom Resource, looks for deployments which are labeled with <strong>service-binding/type: kafka</strong> and injects the contents of the <strong>kafka-client-secret</strong> into the deployments. Both the <strong>activity-tracking</strong> and the <strong>recommendation-engine</strong> deployments have the expected label.</p>
</div>
</li>
<li>
<p>Once the service binding is done, the status of the ServiceBinding Custom Resource moves to <strong>Connected</strong>.</p>
<div class="imageblock">
<div class="content">
<img src="_images/openshift-console-service-binding-connected.png" alt="openshift console service binding connected">
</div>
</div>
</li>
<li>
<p>To check the injection of the secret by the Service Binding operator, navigate to the Topology view of the OpenShift console at <a href="https://console-openshift-console.%SUBDOMAIN%/topology/ns/globex-%USERID%?view=graph" class="external" target="openshiftconsole">OpenShift Console</a>. Click on the <strong>activity-tracking</strong> deployment to open the details pane, and click on the deployment name (above the Details, Resources and Observe tabs) to open the full details of the Deployment.</p>
<div class="imageblock">
<div class="content">
<img src="_images/openshift-console-topology-deployment-details.png" alt="openshift console topology deployment details">
</div>
</div>
<div class="paragraph">
<p>Scroll down to the <strong>Volumes</strong> section. Notice that the service binding occurs by injecting a secret into the pod:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/service-binding-secret.png" alt="service binding secret">
</div>
</div>
<div class="paragraph">
<p>Return to the Topology view.</p>
</div>
</li>
<li>
<p>Scale the <strong>activity-tracking</strong> deployment to 1 replica. You can do so by clicking on the <strong>activity-tracking</strong> deployment in the Topology view, and in the details window select the <strong>Details</strong> tab, and click the arrow next to the circle to scale the deployment.</p>
<div class="imageblock">
<div class="content">
<img src="_images/openshift-console-scale-deployment.png" alt="openshift console scale deployment">
</div>
</div>
</li>
<li>
<p>Check the logs of the <strong>activity-tracking</strong> pod, and notice that the pod successfully connects to the Kafka broker instance.<br>
To see the logs, click the <strong>Resources</strong> tab of the deployment, and click on the <strong>View logs</strong> link.<br></p>
<div class="imageblock">
<div class="content">
<img src="_images/openshift-console-pod-logs.png" alt="openshift console pod logs">
</div>
</div>
<div class="paragraph">
<p>Expect to see something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[...]
2023-06-13 10:00:31,873 INFO [io.sma.rea.mes.kafka] (main) SRMSG18258: Kafka producer kafka-producer-tracking-event, connected to Kafka brokers 'kafka-kafka-bootstrap.globex-user1.svc.cluster.local:9092', is configured to write records to 'globex.tracking'
2023-06-13 10:00:33,968 INFO [io.quarkus] (main) activity-tracking-service 1.0.0-SNAPSHOT on JVM (powered by Quarkus 2.7.4.Final) started in 13.993s. Listening on: http://0.0.0.0:8080
2023-06-13 10:00:33,969 INFO [io.quarkus] (main) Profile prod activated.
2023-06-13 10:00:33,969 INFO [io.quarkus] (main) Installed features: [cdi, kafka-client, resteasy-reactive, smallrye-context-propagation, smallrye-health, smallrye-reactive-messaging, smallrye-reactive-messaging-kafka, vertx]</pre>
</div>
</div>
</li>
<li>
<p>Go back to the Topology view, and scale up the <strong>recommendation-engine</strong> deployment to 1 pod.</p>
</li>
<li>
<p>Once the <strong>recommendation-engine</strong> is up and running, check in the Kafdrop UI at <a href="https://kafdrop-globex-%USERID%.%SUBDOMAIN%/" class="external" target="_blank" rel="noopener">kafdrop</a> that a number of new topics have been created:</p>
<div class="imageblock">
<div class="content">
<img src="_images/kafdrop-kafka-streams-topics.png" alt="kafdrop kafka streams topics">
</div>
</div>
<div class="paragraph">
<p>Those are the topics created by the Kafka Streams topology in the Recommendation Engine to calculate the top featured products based on activity events.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_testing_the_globex_coolstuff_application"><a class="anchor" href="#_testing_the_globex_coolstuff_application"></a><a class="link" href="#_testing_the_globex_coolstuff_application">2.5. Testing the Globex Coolstuff application</a></h3>
<div class="paragraph">
<p>Now that the Activity Tracking and Recommendation Engine apps are up and running, we can test the generation of activity events and the calculation of the top featured products.</p>
</div>
<div class="paragraph">
<p>The deployment topology for the workshop includes an activity simulator service which will generate a number of activity events randomly distributed over a list of products. These activity events are sent to the Activity Tracking service and transformed into Kafka messages in the <code>globex.tracking</code> topic. These messages are consumed by the Recommendation Engine app to calculate the top featured products.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In a browser window, navigate to the Topology view of the lab&#8217;s OpenShift cluster at <a href="https://console-openshift-console.%SUBDOMAIN%/topology/ns/globex-%USERID%?view=graph" class="external" target="openshiftconsole">OpenShift Console</a>.</p>
</li>
<li>
<p>Open the URL to the <strong>activity-tracking-simulator</strong> application by clicking the <span class="image"><img src="_images/console-open-url.png" alt="30" width="30"></span> icon next to the blue circle representing the <strong>activity-tracking-simulator</strong> deployment.</p>
<div class="paragraph">
<p>Alternatively, open a browser tab and navigate to <a href="https://activity-tracking-simulator-globex-%USERID%.%SUBDOMAIN%/" class="external" target="activity-tracking-simulator">Activity Tracking Simulator</a>.</p>
</div>
</li>
<li>
<p>This opens a Swagger UI page which allows you to use the REST API of the application. The REST application has only one operation, <code>POST /simulate</code>.</p>
<div class="imageblock">
<div class="content">
<img src="_images/activity-tracking-simulator-swagger-ui.png" alt="activity tracking simulator swagger ui">
</div>
</div>
</li>
<li>
<p>Generate a number of activity events. Click the <strong>Try it out</strong> button, and set <code>count</code> to any value between 100 and 1000. Click <strong>Execute</strong>.</p>
</li>
<li>
<p>You can use the Kafdrop UI to inspect the messages sent to the <strong>globex.tracking</strong> topic of the Kafka broker.<br>
Navigate to the Kafdrop UI at <a href="https://kafdrop-globex-%USERID%.%SUBDOMAIN%/" class="external" target="_blank" rel="noopener">kafdrop</a> and click on the <strong>globex-tracking</strong> topic in the topic list. Notice the activity event messages produced by the Activity Tracking service:</p>
<div class="imageblock">
<div class="content">
<img src="_images/kafdrop-topic-messages.png" alt="kafdrop topic messages">
</div>
</div>
<div class="paragraph">
<p>Click on the link of the only partition of this topic to see the list of messages. Click on the <span class="image"><img src="_images/kafdrop-expand-message.png" alt="kafdrop expand message"></span> icon next to a message to see its content.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/kafdrop-topic-messages-detail.png" alt="kafdrop topic messages detail">
</div>
</div>
</li>
<li>
<p>The featured product list calculated by the Recommendation Engine is produced to the <strong>globex.recommendation-product-score-aggregated-changelog</strong> topic. The list is recalculated roughly every 10 seconds as long as activity events are produced. Every calculation produces a message to the changelog topic. The last message in the topic represents the latest top featured list.</p>
<div class="imageblock">
<div class="content">
<img src="_images/kafdrop-messages-aggregated-chainlog.png" alt="kafdrop messages aggregated chainlog">
</div>
</div>
</li>
<li>
<p>In a browser window, navigate to the home page of the Globex Coolstuff web application. Notice that the home page now shows a list of featured products.</p>
<div class="imageblock">
<div class="content">
<img src="_images/globex-coolstuff-home-page-featured.png" alt="globex coolstuff home page featured">
</div>
</div>
<div class="paragraph">
<p>Also, the product page now shows a banner with the featured products.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/globex-coolstuff-product-page-featured.png" alt="globex coolstuff product page featured">
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Congratulations! You reached the end of this part of the workshop, in which you added event streaming capabilities to the Globex Coolstuff application, using AMQ Streams, and Service Binding to connect your apps to the Kafka instance.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_appendix"><a class="anchor" href="#_appendix"></a><a class="link" href="#_appendix">3. Appendix</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="service-binding-appendix"><a class="anchor" href="#service-binding-appendix"></a><a class="link" href="#service-binding-appendix">3.1. Learn more about Service Binding</a></h3>
<div class="paragraph">
<p>Service Binding allows you to communicate connection details and secrets to an application to allow it to bind to a service. In this context, a service can be anything: a Kafka instance, a NoSQL database, etc. By using Service Binding, we no longer need to configure connection details (host, port), authentication mechanisms (SASL, OAuth) and credentials (username/password, client id/client secret) in an application. Instead, Service Binding injects these variables into your application container (as files or environment variables) for your application to consume. The Quarkus Kubernetes Service Binding extension enables Quarkus applications to automatically pickup these variables, injected as files, from the container&#8217;s filesystem, removing the need to specify any configuration settings in the application resources (e.g configuration files) themselves.</p>
</div>
<div class="paragraph">
<p><a href="https://servicebinding.io/" class="external" target="_blank" rel="noopener">Read more about Service Binding For Kubernetes</a> .</p>
</div>
<div class="paragraph">
<p>&lt;&lt; <a href="#event-goals">back to instructions</a></p>
</div>
</div>
<div class="sect2">
<h3 id="kafka-params-appendix"><a class="anchor" href="#kafka-params-appendix"></a><a class="link" href="#kafka-params-appendix">3.2. Learn more the Kafka topic configuration parameters</a></h3>
<div class="ulist">
<ul>
<li>
<p>Partitions are distinct lists of messages within a topic and enable parts of a topic to be distributed over multiple brokers in the cluster. A topic can contain one or more partitions, enabling producer and consumer loads to be scaled.</p>
</li>
<li>
<p>Replicas are copies of partitions in a topic. Partition replicas are distributed over multiple brokers in the cluster to ensure topic availability if a broker fails. When a follower replica is in sync with a partition leader, the follower replica can become the new partition leader if needed.</p>
</li>
<li>
<p>Message retention time is the amount of time that messages are retained in a topic before they are deleted or compacted, depending on the cleanup policy. Retention size is the maximum total size of all log segments in a partition before they are deleted or compacted. For this workshop you can keep the default values.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="02-architecture.html" class="query-params-link">2. Architecture</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <img
          src="../_/img/app-services-logo.png" height="40px" alt="Cloud Native Architecture Solution Patterns"  href="https://redhat.com" ></a>
</footer><script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
